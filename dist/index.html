<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.css"
    />
    <link rel="stylesheet" href="style.css" />
    <script>
      const debounce = (func, delay = 1000) => {
      let timeoutId;
      return (...args) => {
          if(timeoutId){
              clearTimeout(timeoutId);
          }
          timeoutId = setTimeout(() => {
              func.apply(null,args)
          },delay)
      };
    };
    </script>
    
  </head>
  <body>
    <!-- Header -->
    <section class="hero is-primary is-bold" style="background: linear-gradient(90deg, #0F2027 0%, #203A43 35%, #2C5364 100%);">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">
            Movie Fight
            <span class="icon">
              <i class="fas fa-film"></i>
            </span>
          </h1>
        </div>
      </div>
    </section>


    <div class="container">
      <div class="columns">
        <div class="column">
          <div id="left-autocomplete"></div>
          <div id="left-summery"></div>
        </div>

        <div class="column">
          <div id="right-autocomplete"></div>
          <div id="right-summery"></div>
        </div>
      </div>

      <div class="column is-half notification is-primary tutorial">
        <h1 class="title">Search Fot a Movie on Both Sides</h1>
        <p class="subtitle">We will tell you which is best!</p>
      </div>
    </div>



    <!-- <script src="utils.js"></script> -->
    <script>
    /******************************************************* 
        Re-usable code for Auto Complete function
    *********************************************************/
    const createAutoComplete = ({ root, renderOption, onOptionSelect, inputValue, fetchData }) => {   
        root.innerHTML = `
        <label><b>Search</b></label>
        <input class="input" />
        <div class="dropdown">
            <div class="dropdown-menu">
                <div class="dropdown-content results"></div>
            </div>
        </div>
        `;
            
        const input = root.querySelector('input');
        const dropdown = root.querySelector('.dropdown');
        const resultWrapper = root.querySelector('.results');

        const onInput = async event => {
            const items = await fetchData(event.target.value);

            if(!items.length){
                dropdown.classList.remove('is-active');
                return;
            }

            resultWrapper.innerHTML = '';
            dropdown.classList.add('is-active');
            items.forEach(item => {
                const option = document.createElement('a');
                

                option.classList.add('dropdown-item');
                option.innerHTML = renderOption(item);
                option.addEventListener('click', () => {
                    dropdown.classList.remove('is-active');
                    input.value = inputValue(item);
                    onOptionSelect(item);
                });

                resultWrapper.appendChild(option);
            });
        };
        input.addEventListener('input', debounce(onInput, 500));

        document.addEventListener('click', event => {
            if(!root.contains(event.target)){
                dropdown.classList.remove('is-active');
            }
        });
    };
    </script>
    <script>
      const autocompleteConfig = {
    renderOption: (movie) => {
        const imgSrc = movie.Poster === 'N/A' ? '' : movie.Poster;
        return `
        <img src="${imgSrc}" />
        ${movie.Title} (${movie.Year})
    `
    },
    inputValue: (movie) => {
        return movie.Title;
    },
    async fetchData(seachTerm) {
        const response = await axios.get('http://www.omdbapi.com/', {
            params: {
                apikey: 'c326d45c',
                s: seachTerm
            }
        });
        
        if(response.data.Error){
            return [];
        }
        
         return response.data.Search;       
    }
};

createAutoComplete({
    // The dots means take all the properties of autocompleteConfig to this function
    ...autocompleteConfig,
    root: document.querySelector('#left-autocomplete'),
    onOptionSelect: (movie) => {
        document.querySelector('.tutorial').classList.add('is-hidden');
        onMovieSelect(movie, document.querySelector('#left-summery'), 'left');
    } 
});
createAutoComplete({
    ...autocompleteConfig,
    root: document.querySelector('#right-autocomplete'),
    onOptionSelect: (movie) => {
        document.querySelector('.tutorial').classList.add('is-hidden');
        onMovieSelect(movie, document.querySelector('#right-summery'), 'right');
    } 
});

let leftMovie;
let rightMovie;
const onMovieSelect = async (movie,summeryElement, side) =>{
    const response = await axios.get('http://www.omdbapi.com/', {
        params: {
            apikey: 'c326d45c',
            i: movie.imdbID
        }
    });

    summeryElement.innerHTML = movieTemplate(response.data);

    if(side === 'left'){
        leftMovie = response.data;
    }else {
        rightMovie = response.data
    }

    if (leftMovie && rightMovie) {
        runComperison(); 
    }

};

const runComperison = () => {
    const leftSideStats = document.querySelectorAll('#left-summery .notification');
    const rightSideStats = document.querySelectorAll('#right-summery .notification');

    leftSideStats.forEach((leftStat, index) => {
        const rightStat = rightSideStats[index];

        const leftSideValue = leftStat.dataset.value;
        const rightSideValue = rightStat.dataset.value;

        if (rightSideValue > leftSideValue) {
            leftStat.classList.remove('is-primary');
            leftStat.classList.add('is-warning');
        } else {
            rightStat.classList.remove('is-primary');
            rightStat.classList.add('is-warning');
        }
    });
};

const movieTemplate = (movieDetail) => {
    const dollars = parseInt(movieDetail.BoxOffice.replace(/\$/g, '').replace(/,/g, ''));
    const metascore = parseInt(movieDetail.Metascore);
    const imbdRating = parseFloat(movieDetail.imdbRating);
    const imbdVotes = parseInt((movieDetail.imdbVotes).replace(/,/g, '')); 

    const awards = movieDetail.Awards.split(' ').reduce((prev, word) => {
        const value = parseInt(word);

        if (isNaN(value)){
            return;
        } else {
            return prev + value;
        }
    }, 0);
    return `
        <article class="media">
            <figure class="media-left">
                <p class="image">
                    <img src="${movieDetail.Poster}" />
                </p>
            </figure>

            <div class="media-content">
                <div class="content">
                    <h1>${movieDetail.Title}</h1>
                    <h4>${movieDetail.Genre}</h4>
                    <p>${movieDetail.Plot}</p>
                </div>
            </div>
        </article>
        
        <article data-value=${awards} class="notification is-primary">
            <p class="title">${movieDetail.Awards}</p>
            <p class="subtitle">Awards</p>
        </article>
        <article data-value=${dollars} class="notification is-primary">
            <p class="title">${movieDetail.BoxOffice}</p>
            <p class="subtitle">Box Office</p>
        </article>
        <article data-value=${metascore} class="notification is-primary">
            <p class="title">${movieDetail.Metascore}</p>
            <p class="subtitle">Metascore</p>
        </article>
        <article data-value=${imbdRating} class="notification is-primary">
            <p class="title">${movieDetail.imdbRating}</p>
            <p class="subtitle">IMDB Rating</p>
        </article>
        <article data-value=${imbdVotes} class="notification is-primary">
            <p class="title">${movieDetail.imdbVotes}</p>
            <p class="subtitle">IMDB Votes</p>
        </article>
    `;
};

    </script>
  </body>
</html>
